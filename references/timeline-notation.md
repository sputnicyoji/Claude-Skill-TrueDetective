# 时序图符号规范

> 用于 Phase 4 报告中的时序分析，适用于任意代码库

## 基本符号

### 时间轴
```
─────────────────────────────────────→ 时间
```

### 事件标记
```
│       竖线表示事件发生点
↓       箭头表示因果关系
```

### 并行操作
```
═══════  双线表示异步/并行操作
```

---

## 标准模板

### 单线时序

```
时间线:
─────────────────────────────────────────────────────────────→
     │              │                    │
   事件A          事件B                事件C
     ↓              ↓                    ↓
  [影响说明]     [影响说明]           [影响说明]
```

### 并行竞态

```
主线程:
─────────────────────────────────────────────────────────────→
     │                          │
  开始加载                    使用数据 ← 可能此时数据还没准备好!
     ║
     ║ 异步
     ↓
异步任务:
═════════════════════════════════════════════════════════════→
                    │
                 加载完成
                    ↓
                 回调执行
```

### 正常 vs 异常路径对比

```
【正常路径】A先于B
─────────────────────────────────────────→
     │         │
    A完成     B执行
     ↓         ↓
   数据就绪   读取成功 ✅


【异常路径】B先于A
─────────────────────────────────────────→
     │         │
    B执行     A完成
     ↓         ↓
   数据空!   太晚了 ❌
```

---

## 常见时序场景

### JavaScript Promise/async-await

```
async function:
─────────────────────────────────────────────────────────────→
│              │                    │
await fetch()  await process()     return result
↓              ↓                    ↓
可能被拒绝     可能超时             可能异常
```

### React useEffect 竞态

```
组件渲染:
─────────────────────────────────────────────────────────────→
│               │                    │
render #1      render #2           setState
↓               ↓                    ↓
发起请求1      发起请求2           ← 哪个先返回？
║               ║
↓               ↓
请求1完成      请求2完成
(可能晚)       (可能先)
               ↓
               覆盖旧状态! ❌
```

### 多线程/协程竞争

```
线程A:
─────────────────────────────────────────────────────────────→
│               │                    │
读取变量X      修改变量X           检查变量X
↓               ↓                    ↓
X=1            X=2                 期望X=2

线程B (并发):
═════════════════════════════════════════════════════════════→
        │
      修改变量X
        ↓
       X=3 ← 竞态写入！
```

### 事件触发链

```
事件系统:
─────────────────────────────────────────────────────────────→
│                          │                    │
emit('event')           handler1执行          handler2执行
↓                          ↓                    ↓
同步/异步广播            可能修改状态          读取已修改的状态
```

---

## 标注符号

| 符号 | 含义 |
|------|------|
| ✅ | 正常/成功 |
| ❌ | 异常/失败 |
| ⚠️ | 警告/可能出问题 |
| ← | 问题点标注 |
| 🔥 | 关键节点 |

---

## 复杂场景示例

### API 请求竞态

```
场景: 用户快速切换页面，旧请求的响应覆盖新数据

页面A:
─────────────────────────────────────────────────────────────→
│               │
切换到页面A     fetch(pageA_data)
│               ║
│               ║ 网络延迟 (2s)
│               ↓
│             响应A返回
│               ↓
│             setState(dataA) ← 晚于响应B！覆盖了新数据 ❌

页面B (用户快速切换):
═════════════════════════════════════════════════════════════→
     │               │
   切换到页面B     fetch(pageB_data)
     │               ║
     │               ║ 网络延迟 (0.5s)
     │               ↓
     │             响应B返回
     │               ↓
     │             setState(dataB) ✅
```

**根因**: 没有取消旧请求或检查请求是否过期，导致响应顺序与发起顺序不一致时数据错乱。

---

### 状态恢复时序问题

```
场景: 应用重启后状态恢复不完整

首次启动 (正常):
─────────────────────────────────────────────────────────────→
│               │                    │
initDefaults() loadConfig()        setupUI()
↓               ↓                    ↓
默认值设置     配置覆盖默认值       UI初始化 ✅


重启恢复 (异常):
═════════════════════════════════════════════════════════════→
│               │                    │
restoreState() 跳过loadConfig()    setupUI()
↓               ↓                    ↓
恢复缓存状态   配置未加载!         UI使用缓存状态
               ← 缺失步骤           可能过期/不一致 ❌
```

**根因**: 重启路径假设缓存完整，跳过了某些必要的初始化步骤。
