# 子代理探索 Prompt 模板

> 用于 Phase 2 并行探索的标准化 Prompt，适用于任意代码库

## 通用探索模板

```markdown
## 任务: 验证假设 [H{n}]

**假设内容**: {假设描述}

**验证入口**: `{文件路径}:{方法名/函数名}`

**问题分类**: {P1-P6 分类}

---

### 执行步骤

1. **定位入口**
   - 读取入口文件
   - 理解方法/函数职责

2. **追踪数据流**
   - 识别关键变量/状态
   - 追踪调用链 (caller → callee)
   - 追踪事件/回调链

3. **收集证据**
   - 记录关键代码片段
   - 标注文件路径和行号
   - 解读代码含义

4. **判定假设**
   - 假设是否成立？
   - 如果部分成立，哪部分成立？

---

### 输出格式

```
## 探索结果: H{n}

### 假设判定
- **结果**: [成立 / 不成立 / 部分成立]
- **置信度**: [高 / 中 / 低]

### 证据列表

#### E{n}.1
- **来源**: `{路径}:{行号}`
- **代码**:
\`\`\`{language}
{代码片段}
\`\`\`
- **解读**: {这段代码说明了什么}

#### E{n}.2
...

### 追踪路径
{入口} → {方法1} → {方法2} → {关键点}

### 其他发现
- {追踪过程中发现的其他问题或线索}
```

---

**重要约束**:
- 只追踪，不修复
- 每个结论必须有代码证据
- 发现新线索要记录，但不要偏离主假设
```

---

## P1 异步/并发专用模板

```markdown
## 任务: 异步/并发分析

**假设**: {异步操作 A 和 B 存在竞态}

**验证入口**: `{文件路径}`

---

### 执行步骤

1. **识别异步点**
   - 找出所有 async/await / Promise / callback
   - 找出所有并发原语 (thread/goroutine/Task)
   - 找出所有同步机制 (lock/mutex/semaphore)

2. **画时序图**
   ```
   时间 →
   ─────────────────────────────────→
      │         │          │
    操作A     操作B      操作C
      ↓         ↓          ↓
    [说明]   [说明]     [说明]
   ```

3. **分析快慢路径**
   - 快路径: A 先完成
   - 慢路径: B 先完成
   - 哪条路径会出问题？

4. **检查隐式依赖**
   - 代码是否假设了某个顺序？
   - 这个假设总是成立吗？

---

### 输出格式

包含时序图 + 快慢路径分析
```

---

## P2 状态管理专用模板

```markdown
## 任务: 状态管理分析

**假设**: {某状态在恢复时未正确同步}

**验证入口**: `{状态管理相关文件}`

---

### 执行步骤

1. **追踪状态生命周期**
   - 创建: 在哪里初始化？
   - 修改: 有哪些写入点？
   - 保存: 如何持久化？
   - 恢复: 如何读取？

2. **对比代码路径**
   - 首次运行时的初始化逻辑
   - 恢复运行时的初始化逻辑
   - 两者有什么不同？

3. **检查持久化格式**
   - 存储包含哪些字段？
   - 是否遗漏了必要字段？
   - 版本兼容性如何？

---

### 输出格式

包含状态生命周期图 + 路径对比
```

---

## P3 UI/渲染专用模板

```markdown
## 任务: UI/渲染问题分析

**假设**: {UI 组件 X 未正确渲染}

**验证入口**: `{组件文件路径}`

---

### 执行步骤

1. **确认数据层**
   - 数据是否正确？(调试/打印)
   - 数据来源是什么？

2. **确认状态更新**
   - 状态变更是否被检测？
   - 响应式机制是否正常工作？

3. **确认视图绑定**
   - 组件是否监听/订阅了变更？
   - 渲染条件是否正确？

4. **检查生命周期**
   - 组件挂载/更新时机
   - 副作用执行时机

---

### 追踪路径示例
```
数据变更
  ↓
状态更新 (setState/reactive)
  ↓
视图重渲染
  ↓
DOM 更新
```
```

---

## P5 资源/依赖专用模板

```markdown
## 任务: 资源/依赖问题分析

**假设**: {资源 X 加载失败/缺失}

**验证入口**: `{资源加载代码路径}`

---

### 执行步骤

1. **确认资源路径**
   - 路径拼写是否正确？
   - 相对/绝对路径是否正确？
   - 大小写是否正确？

2. **检查加载流程**
   - 加载是同步还是异步？
   - 回调/Promise 处理是否正确？
   - 错误处理是否完善？

3. **确认资源生命周期**
   - 资源何时加载？
   - 资源何时释放？
   - 是否被过早 GC？

4. **检查依赖关系**
   - 模块依赖是否正确声明？
   - 是否存在循环依赖？

---

### 输出格式

包含加载流程图 + 生命周期分析
```

---

## 并行启动示例

```javascript
// Phase 2: 启动 3 个并行探索子代理

Task(subagent_type="Explore", prompt=`
  [P1 异步/并发模板]
  假设: fetchData 和 renderUI 存在竞态，数据未返回就开始渲染
  入口: src/components/DataList.tsx:useEffect
`)

Task(subagent_type="Explore", prompt=`
  [P2 状态管理模板]
  假设: 用户偏好设置未正确从 localStorage 恢复
  入口: src/stores/userPreferences.ts:loadPreferences
`)

Task(subagent_type="Explore", prompt=`
  [P5 资源/依赖模板]
  假设: 图片资源路径在生产环境下不正确
  入口: src/utils/assetPath.ts:getImageUrl
`)
```

---

## 证据质量检查

| 检查项 | 标准 |
|--------|------|
| 有文件路径? | 必须 `path/file.ext:123` |
| 有代码片段? | 必须有关键代码 |
| 有解读? | 必须解释代码含义 |
| 支持假设? | 明确说明支持/反对 |
| 语言标识? | 代码块需标注语言 |
