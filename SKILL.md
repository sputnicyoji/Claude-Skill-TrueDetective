---
name: true-detective-universal
description: 通用根因分析工具，适用于任意代码库。假设驱动，并行探索，只分析不修复。用于调试 Bug、排查错误、分析异常行为，支持任何语言和框架。 | Universal root cause analysis for any codebase. Hypothesis-driven, parallel exploration, no fixing. Use when debugging bugs, investigating errors, or analyzing unexpected behavior in any language or framework.
---

# True Detective Universal - 通用根因分析专家

> "不要猜测，要追踪。不要修复，要理解。"

**核心定位**: 专一分析和定位根因，**绝不修复**。适用于任意代码库。

## 铁律 (CRITICAL)

1. **禁止修复** - 只输出根因报告，不写任何修改代码
2. **探索先于假设** - 假设生成前必须先理解代码结构
3. **假设先行** - 读代码前必须先列出 3+ 个假设
4. **并行探索** - 多假设必须并行验证，禁止串行
5. **证据为王** - 每个结论必须有代码证据支撑
6. **ultrathink 必触发** - Phase 3 汇聚阶段强制深度推理

---

## 四阶段工作流

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: PARSE                                                  │
│  关键词提取 → 问题分类 → 🔥代码结构探索 → 假设生成               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: EXPLORE (并行)                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                       │
│  │ 假设 A   │  │ 假设 B   │  │ 假设 C   │  ← Task 子代理并行     │
│  │ 探索代理 │  │ 探索代理 │  │ 探索代理 │                       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                       │
│       ↓             ↓             ↓                              │
│    证据集 A      证据集 B      证据集 C                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: CONVERGE                                               │
│  证据汇聚 → ultrathink 深度推理 → 权重评估 → 根因锁定            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Phase 4: REPORT                                                 │
│  结构化报告 → 证据链 → 时序图(可选) → 修复建议                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: PARSE (现象解析)

### 1.1 关键词提取

从用户描述中提取:
- **主体**: 什么功能/模块出问题？
- **现象**: 具体表现是什么？
- **时机**: 什么情况下发生？
- **预期**: 正确行为应该是什么？

### 1.2 问题分类 (通用)

| 分类 | 特征 | 典型关键词 |
|------|------|------------|
| **异步/并发** | 时序依赖、回调、Promise、线程 | "有时"、"偶发"、"race condition" |
| **状态管理** | 数据不一致、缓存、存储 | "退出后"、"重启"、"不一致" |
| **渲染/UI** | 显示异常、不刷新 | "不显示"、"闪烁"、"错位" |
| **配置/数据** | 配置表、环境变量、参数 | "配置"、"参数"、"找不到" |
| **资源/依赖** | 加载失败、依赖缺失 | "加载"、"丢失"、"null/undefined" |
| **生命周期** | 初始化、销毁时机 | "启动时"、"关闭后"、"第一次" |

### 1.3 代码结构探索 🔥 关键步骤

**在假设生成之前，必须先理解代码结构**

使用 Task 工具进行代码探索:

```
Task(subagent_type="Explore", prompt="
  探索代码库结构，找出与 [问题关键词] 相关的:
  1. 核心模块/目录结构
  2. 关键类/函数入口
  3. 依赖关系和调用链
  4. 相关配置文件

  输出: 模块定位 + 入口点列表
")
```

**探索检查清单**:
- [ ] 已识别问题相关的核心模块
- [ ] 已找到关键入口函数/类
- [ ] 已理解基本的架构层次

**输出格式**：
```markdown
## 代码结构探索结果

**问题关键词**: [从 1.1 提取]
**相关模块**:
- 主模块: path/to/module/
- 关联模块: path/to/related/ (如有)

**关键入口**:
- `path/file.ext:functionName` - 描述
- `path/file.ext:className` - 描述
```

### 1.4 假设生成 (基于探索结果)

**必须生成 3-5 个假设**，每个假设包含:
- 假设描述
- 验证路径 (从探索获取的入口开始追踪)
- 预期证据 (如果假设成立，应该看到什么)

```markdown
## 假设列表

### H1: [假设描述]
- 验证入口: `路径/文件.ext:方法名`
- 预期证据: xxx
- 优先级: 高/中/低

### H2: ...
```

---

## Phase 2: EXPLORE (并行探索)

### 2.1 启动并行子代理

**必须使用 Task 工具并行启动探索代理**:

```
对于每个假设 H:
  Task(subagent_type="Explore", prompt="
    验证假设: [H.描述]
    入口: [H.验证入口]

    执行步骤:
    1. 定位入口代码
    2. 追踪数据流 (调用链/事件链)
    3. 收集证据 (代码片段+行号)
    4. 判断假设是否成立

    输出格式:
    - 假设: [成立/不成立/部分成立]
    - 证据: [代码路径:行号] [关键代码片段]
    - 发现: [追踪过程中的其他发现]
  ")
```

### 2.2 通用追踪模式

| 问题类型 | 追踪策略 |
|----------|----------|
| 异步/并发 | 画时序图，标注所有异步点 (await/callback/thread) |
| 状态管理 | 追踪状态的读写点，检查一致性 |
| 渲染/UI | 追踪数据 → 视图的更新链路 |
| 配置/数据 | 查配置加载和使用处 |
| 资源/依赖 | 追踪加载流程和回调处理 |
| 生命周期 | 检查初始化/销毁顺序和依赖 |

### 2.3 证据收集模板

```markdown
## 证据 E[n]

**来源**: `文件路径:行号`
**类型**: 代码/日志/配置/时序
**内容**:
```code
// 关键代码片段
```
**解读**: 这段代码说明了...
**支持假设**: H1 / H2 / ...
```

---

## Phase 3: CONVERGE (证据汇聚) 🔥 ultrathink 必触发

### 3.1 触发 ultrathink

**此阶段必须使用 ultrathink 进行深度推理**:

```
ultrathink:

  汇总所有子代理的证据:
  - 假设 H1: [成立/不成立] - 证据 E1, E3
  - 假设 H2: [成立/不成立] - 证据 E2
  - 假设 H3: [成立/不成立] - 证据 E4, E5

  深度分析:
  1. 哪些证据相互支持？
  2. 哪些证据相互矛盾？
  3. 是否存在组合因素？(A+B 才触发)
  4. 是否有遗漏的假设？

  根因锁定:
  - 主根因: [描述]
  - 置信度: [高/中/低]
  - 支撑证据: [E1, E3, ...]
```

### 3.2 证据权重评估

| 权重 | 标准 |
|------|------|
| **强** | 直接代码证据，100% 复现路径 |
| **中** | 间接证据，逻辑推断 |
| **弱** | 猜测，需要更多验证 |

### 3.3 根因确认检查

- [ ] 根因能完整解释所有现象吗？
- [ ] 有没有更简单的解释？(奥卡姆剃刀)
- [ ] 修复此根因后，问题是否必然解决？

---

## Phase 4: REPORT (根因报告)

### 4.1 报告模板

```markdown
# 根因分析报告

## 问题概述
- **现象**: [用户描述]
- **分类**: [异步/状态/UI/...]
- **涉及模块**: [模块列表]

## 根因定位

### 主根因
[一句话描述根因]

### 技术细节
[详细技术解释，包含代码路径]

### 证据链
1. [证据1] → 说明了 → [结论1]
2. [证据2] → 说明了 → [结论2]
3. [结论1] + [结论2] → 导致 → [根因]

## 时序分析 (如适用)
```
时间线:
───────────────────────────────────────────→
   │          │           │
 事件A      事件B       事件C
   ↓          ↓           ↓
 [说明]    [说明]      [说明]
```

## 假设验证记录
| 假设 | 结果 | 关键证据 |
|------|------|----------|
| H1   | ✅/❌ | E1, E3   |
| H2   | ✅/❌ | E2       |

## 修复建议 (可选)
- [建议1]: [描述] - 风险: 高/中/低
- [建议2]: [描述] - 风险: 高/中/低

## 备注
- [其他发现]
- [潜在风险]
- [相关问题]

---
**分析完成，不含修复代码**
```

---

## 🚩 红旗列表

| 红旗信号 | 正确做法 |
|----------|----------|
| "让我先修复一下" | **停止** - 只分析不修复 |
| "直接生成假设" | **停止** - 先探索代码结构 |
| "看起来是这个问题" | 继续验证其他假设 |
| "我直接看代码" | 先列假设，再看代码 |
| "一个一个文件看" | 启动并行子代理 |
| "应该是这样" | 找代码证据，不要猜 |
| "太简单了" | 执行完整四阶段 |

---

## 🛡️ 反合理化表

| 借口 | 反驳 | 正确做法 |
|------|------|----------|
| "问题很明显" | 明显≠正确 | 多假设验证 |
| "不需要探索结构" | 假设需要入口支撑 | 1.3 必执行 |
| "我已经知道答案了" | 知道≠证明 | 找代码证据 |
| "顺便修一下" | 职责分离 | 只报告根因 |
| "串行更清晰" | 清晰≠高效 | 并行探索 |
| "不需要 ultrathink" | 深度≠浪费 | Phase 3 必触发 |

---

## 快速参考

### 触发命令
```
/true-detective-universal [问题描述]
/tdu [问题描述]
```

### 输出物
1. 代码结构探索结果 (Phase 1.3)
2. 假设列表 (Phase 1.4)
3. 证据集合 (Phase 2)
4. 根因报告 (Phase 4)

### 不输出
- 修复代码
- PR/Commit
- 直接修改文件

---

## 详细参考

| 文档 | 内容 |
|------|------|
| @references/problem-patterns.md | 通用问题模式库 |
| @references/exploration-prompts.md | 子代理 Prompt 模板 |
| @references/evidence-templates.md | 证据收集模板 |
| @references/timeline-notation.md | 时序图符号规范 |
| @assets/report-template.md | 完整报告模板 |
